//@library('pipelib@v0.0.1')

//def util = new io.venicegeo.pipelib.Util()

node ('sl61') {
  stage("Pip Reqs") {
    git url: "https://github.com/venicegeo/bf-api.git"
    sh "pip install --user -r ./requirements.txt"
    sh "./scripts/extract-historical-data.sh"

  stage("Security Scans") {
    withCredentials([[$class: 'StringBinding', credentialsId: '978C467A-2B26-47AE-AD2F-4AFD5A4AF695',     variable: 'THREADFIXKEY']]) {
      parallel(
        fortifyScan: {
          sh "/opt/hp_fortify_sca/bin/sourceanalyzer -b ${env.BUILD_NUMBER} ./{*.py,**/*.py}"
          sh "/opt/hp_fortify_sca/bin/sourceanalyzer -b ${env.BUILD_NUMBER}  -scan -Xmx8G -f fortifyResults-${env.BUILD_NUMBER}.fpr"
          sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@fortifyResults-${env.BUILD_NUMBER}.fpr https://threadfix.devops.geointservices.io/rest/applications/57/upload?apiKey=$THREADFIXKEY"
        },
        owaspScan: {
          sh '/opt/dependency-check/bin/dependency-check.sh --project "bf-api" --scan "." --format "XML" --enableExperimental'
          sh "/bin/curl -v --insecure -H 'Accept: application/json' -X POST --form file=@dependency-check-report.xml https://threadfix.devops.geointservices.io/rest/applications/57/upload?apiKey=$THREADFIXKEY"
        })
      }
    }
  }
}

